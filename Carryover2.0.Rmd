---
title: "Carryover 2.0"
author: "Kolby Grint"
date: "11/20/2020"
output:
  pdf_document: default
  html_document: default
---


```{r, include= FALSE}
library(car)
library(ggplot2)
library(emmeans)
library(lme4)
library(lmerTest)
library(patchwork)
library(glmmTMB)
library(dplyr)
library(tidyverse)
library(multcomp)
```

```{r}
getwd()

Corn= read.csv(file="Corn_MasterData.csv")
Soybean= read.csv(file="Soybean_MasterData.csv")

CC= read.csv(file= "CoverCropData.csv")
```


```{r}
Corn1 <- Corn %>% 
  mutate(Rep = as_factor(Rep),
         Year = as_factor(Year),
         Herb = fct_recode(Herb,
                          "Control" = "CTRL",
                          "50% fomesafen"  = "FO50",
                          "25% fomesafen" = "FO25",
                          "50% imazethapyr" = "IM50",
                          "25% imazethapyr" = "IM25"),
         Soil= fct_recode(Soil, 
                          "Cover Crop" = "CC",
                          "No-Till" = "NT",
                          "Tillage" = "Till"),
         Crop.Canopy = round(Crop.Canopy/100, 2)) %>%
  filter(!is.na(yield)) %>%
  filter(!is.na(Crop.Canopy)) %>%
  filter(!is.na(Stand.Count)) %>%
  janitor::clean_names()

Soybean1 <- Soybean %>% 
  mutate(Rep = as_factor(Rep),
         Year = as_factor(Year),
         Herb = fct_recode(Herb,
                          "Control" = "CTRL",
                          "50% fomesafen"  = "FO50",
                          "25% fomesafen" = "FO25",
                          "50% imazethapyr" = "IM50",
                          "25% imazethapyr" = "IM25"),
         Soil= fct_recode(Soil, 
                          "Cover Crop" = "CC",
                          "No-Till" = "NT",
                          "Tillage" = "Till"),
         Crop.Canopy = round(Crop.Canopy/100, 2)) %>%
  filter(!is.na(yield)) %>%
  filter(!is.na(Crop.Canopy)) %>%
  filter(!is.na(Stand.Count)) %>%
  janitor::clean_names()

CornCC <- CC %>%
  filter(Crop == "Corn") %>%
  mutate(Rep = as_factor(Rep),
         Year = as_factor(Year),
         Site_Crop_Yr = fct_recode(Site_Crop_Yr,
                          "Arlington 2019" = "ARL_CN_19",
                          "Arlington 2020"  = "ARL_CN_20",
                          "Havelock 2019" = "HAV_CN_19",
                          "Havelock 2020" = "HAV_CN_20",
                          "Lancaster 2019" = "LAN_CN_19",
                          "Lancaster 2020" = "LAN_CN_20"),
         Soil= fct_recode(Soil, 
                          "Cover Crop" = "CC",
                          "No-Till" = "NT",
                          "Tillage" = "Till"),
         Canopy = round(Canopy/100, 3)) %>%
  filter(!is.na(Biomass_kg)) %>%
  janitor::clean_names()

order= c("Tillage", "No-Till", "Cover Crop")
```


```{r}
Corn1 %>%
  ggplot(aes(x = soil, y = yield, color = location)) +
  geom_boxplot() +
  facet_grid(crop ~ year)
```

```{r}
Soybean1 %>%
  ggplot(aes(x = soil, y = yield, color = location)) +
  geom_boxplot() +
  facet_grid(crop ~ year)
```

```{r}

```


# Corn Yield

```{r}
arlcn_yield2= lmer(yield~ soil*herb + (1|rep/year), data= (filter(Corn1, location == "Arlington")))

qqnorm(resid(arlcn_yield2))

plot(arlcn_yield2)
#assumptions look good

anova(arlcn_yield2)
```

### Arlington 2019 Analysis ---- We decided to use only this site-year in the paper
```{r}
arlcn_yield1= lmer(yield~ soil*herb + (1|rep:location), data= (filter(Corn1, site_crop_yr == "ARL_CN_19")))

qqnorm(resid(arlcn_yield1))

plot(arlcn_yield1)
#assumptions look good

anova(arlcn_yield1)
#soil managment fixed effect significant
```

### Lancaster Analysis
```{r}
lancn_yield= lmer(yield~ soil*herb + (1|rep/year), data= (filter(Corn1, location == "Lancaster")))

qqnorm(resid(lancn_yield))

plot(lancn_yield)
#assumptions look good

anova(lancn_yield)
#Soil management fixed effect significant
```

### Havelock Analysis
```{r}
havcn_yield= lmer(yield~ soil*herb + (1|rep/year), data= (filter(Corn1, location == "Havelock")))

qqnorm(resid(havcn_yield))

plot(havcn_yield)
#assumptions look good

anova(havcn_yield)
#soil management significant
```

```{r}
arl_cn_lsmeans<- lsmeans(arlcn_yield1, ~ soil, contr="pairwise", adjust="none")

arl_cn_cld <- cld(arl_cn_lsmeans$lsmeans, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)

arl_cn_cld <- as_tibble(arl_cn_cld) %>% 
  rename(yield = lsmean) %>%
  mutate(soil= factor(soil, levels= order)) %>%
  arrange(soil)
```

```{r}
lan_cn_lsmeans<- lsmeans(lancn_yield, ~ soil, contr="pairwise", adjust="none")

lan_cn_cld <- cld(lan_cn_lsmeans$lsmeans, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)

lan_cn_cld <- as_tibble(lan_cn_cld) %>% 
  rename(yield = lsmean) %>%
  mutate(soil= factor(soil, levels= order)) %>%
  arrange(soil)
```

```{r}
hav_cn_lsmeans<- lsmeans(havcn_yield, ~ soil, contr="pairwise", adjust="none")

hav_cn_cld <- cld(hav_cn_lsmeans$lsmeans, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)

hav_cn_cld <- as_tibble(hav_cn_cld) %>% 
  rename(yield = lsmean) %>%
  mutate(soil= factor(soil, levels= order)) %>%
  arrange(soil)
```

```{r}
y1<- ggplot
```



















## Yield for Majority of Corn studies
```{r}
CN.Mod1= lmer(yield~ Site_crop_yr*Soil*Herb + (1|Site_crop_yr:Rep), data=CNMaj)

qqnorm(resid(CN.Mod1))

plot(CN.Mod1)
#Assumptions for normality and equal variance met beautifully

anova(CN.Mod1)
# Site-year:Soil 2-way interaction significant

cornmeans= lsmeans(CN.Mod1 ,~ Soil|Site_crop_yr, contr="pairwise", adjust="none", type="response")
cornmeans1CLD<- CLD(cornmeans, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)

cornmeans1CLD
```
Tillage Had the highest corn yield at all locations.

```{r}
levels(cornmeans1CLD$Site_crop_yr)= list("Arlington '19" ="ARL_CN_19","Havelock '19"="HAV_CN_19", "Havelock '20"="HAV_CN_20", "Lancaster '19"="LAN_CN_19", "Lancaster '20"="LAN_CN_20")

ylab.text1= expression("Yield kg ha"^"-1")

ggplot(cornmeans1CLD, aes(x= Soil, y= lsmean, label= .group, fill= Site_crop_yr))+
  facet_grid(~Site_crop_yr)+      
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 1600, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,18000)+
    geom_errorbar(aes(ymin= lower.CL, ymax= upper.CL), width= .3)+
    labs(title= "Corn Yield", x= "Soil Management", y= (ylab.text1))+
  ggsave("CornCarryoverYield.jpeg", height= 6, width= 10, dpi=600)
```


## Majority of Corn Canopy Cover
```{r}
CNMaj= CNMaj %>%
  mutate(CNcanopy= Crop.Canopy/100)

CN.Mod2= glmmTMB(CNcanopy~ Site_crop_yr*Soil*Herb + (1|Site_crop_yr:Rep), data=CNMaj, beta_family(link="logit"))

Anova(CN.Mod2)
#Site_crop_yr:Soil 2-way interaction and herbicide fixed effect significant

corncanopy= emmeans(CN.Mod2 ,~ Soil|Site_crop_yr, contr="pairwise", adjust="none", type="response")
corncanopyCLD<- CLD(corncanopy, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)
corncanopyCLD

corncanopyHerb= emmeans(CN.Mod2 ,~ Herb, contr="pairwise", adjust="none", type="response")
corncanopyHerbCLD<- CLD(corncanopyHerb, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)
corncanopyHerbCLD
```
Canopy coverage response varied.
The high rate of imazethapyr reduced canopy coverage.

```{r}
levels(corncanopyCLD$Site_crop_yr)= list("Arlington '19" ="ARL_CN_19","Havelock '19"="HAV_CN_19", "Havelock '20"="HAV_CN_20", "Lancaster '19"="LAN_CN_19", "Lancaster '20"="LAN_CN_20")

ggplot(corncanopyCLD, aes(x= Soil, y= response*100, label= .group, fill= Site_crop_yr))+
  facet_grid(~Site_crop_yr)+      
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 5, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,50)+
    geom_errorbar(aes(ymin= lower.CL*100, ymax= upper.CL*100), width= .3)+
    labs(title= "Corn Canopy Coverage", x= "Soil Management", y= "% Canopy Cover")+
  ggsave("CornCarryoverCanopy.jpeg", height= 6, width= 10, dpi=600)
```

```{r}
ggplot(corncanopyHerbCLD, aes(x= Herb, y= response*100, label= .group, fill= Herb))+
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 5, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,30)+
    geom_errorbar(aes(ymin= lower.CL*100, ymax= upper.CL*100), width= .3)+
    labs(title= , x= "Herbicide Treatment", y= "% Canopy Cover")+
  ggsave("CornCarryoverCanopy_Herbicide.jpeg", height= 6, width= 10, dpi=600)
```


## Arlington Corn 2020 CRD Corn Yield
```{r}
ARL20= filter(Corn1, CRD == "Y")

CN.Mod3= lm(yield~ Soil*Herb, data=ARL20)

qqnorm(resid(CN.Mod3))

plot(CN.Mod3)

anova(CN.Mod3)
#Nothing is significant
```
No significant effects on yield at this location

## Arlington Corn 2020 CRD Canopy Coverage
```{r}
ARL20= ARL20 %>%
  mutate(CNcanopy= Crop.Canopy/100)

CN.Mod4= glmmTMB(CNcanopy~ Soil*Herb, data=ARL20, beta_family(link="logit"))

Anova(CN.Mod4)
#Nothing significant
```
No significant effects on Canopy coverage at this location


#Soybean Yield 
```{r}
SB.Mod1= lmer(yield~ Site_crop_yr*Soil*Herb + (1|Site_crop_yr:Rep), data=Soybean1)

qqnorm(resid(SB.Mod1))

plot(SB.Mod1)
#Assumptions for normality and equal variance are met

anova(SB.Mod1)
#Site_crop_yr:Soil  2- way interacion significant

SByield= lsmeans(SB.Mod1 ,~ Soil|Site_crop_yr, contr="pairwise", adjust="none", type="response")
SByieldCLD<- CLD(SByield, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)
SByieldCLD
```
Cover crop treatment reduced yield at Lancaster in 2019. Yield was the same in all other studies.

```{r}
levels(SByieldCLD$Site_crop_yr)= list("Arlington '19" ="ARL_SB_19", "Arlington '20"="ARL_SB_20", "Havelock '19"="HAV_SB_19", "Havelock '20"="HAV_SB_20", "Lancaster '19"="LAN_SB_19", "Lancaster '20"="LAN_SB_20")

levels(SByieldCLD$Soil)= list("NT"="NT", "CT"="Till", "CC"="NT+CC")

ggplot(SByieldCLD, aes(x= Soil, y= lsmean, label= .group, fill= Site_crop_yr))+
  facet_grid(~Site_crop_yr)+      
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 600, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,6000)+
    geom_errorbar(aes(ymin= lower.CL, ymax= upper.CL), width= .3)+
    labs(title= "Soybean Yield", x= "Soil Management", y= (ylab.text1))+
  ggsave("SBCarryoverYield.jpeg", height= 6, width= 10, dpi=600)
```


## Soybean Canopy Coverage
```{r}
Soybean1= Soybean1 %>%
  mutate(CNcanopy= Crop.Canopy/100)

SB.Mod2= glmmTMB(CNcanopy~ Site_crop_yr*Soil*Herb + (1|Site_crop_yr:Rep), data=Soybean1, beta_family(link="logit"))

Anova(CN.Mod2)
#Site_crop_yr:Soil 2-way interaction and Herb fixed effect significant.

SBcanopy= emmeans(SB.Mod2 ,~ Soil|Site_crop_yr, contr="pairwise", adjust="none", type="response")
SBcanopyCLD<- CLD(SBcanopy, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)
SBcanopyCLD

SBcanopyHerb= emmeans(SB.Mod2 ,~ Herb, contr="pairwise", adjust="none", type="response")
SBcanopyHerbCLD<- CLD(SBcanopyHerb, alpha=0.05, Letters=letters, adjust="none", sort=TRUE, reverse=TRUE)
SBcanopyHerbCLD
```
Effect on canopy coverage varied by soil treatment between site-years, tillage had increased canopy coverage in 4 out of 6 site years.
The high rate of mesotrione reduced canopy coverage.


```{r}
levels(SBcanopyCLD$Site_crop_yr)= list("Arlington '19" ="ARL_SB_19", "Arlington '20"="ARL_SB_20", "Havelock '19"="HAV_SB_19", "Havelock '20"="HAV_SB_20", "Lancaster '19"="LAN_SB_19", "Lancaster '20"="LAN_SB_20")

levels(SBcanopyCLD$Soil)= list("NT"="NT", "CT"="Till", "CC"="NT+CC")

ggplot(SBcanopyCLD, aes(x= Soil, y= response*100, label= .group, fill= Site_crop_yr))+
  facet_grid(~Site_crop_yr)+      
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 5, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,50)+
    geom_errorbar(aes(ymin= lower.CL*100, ymax= upper.CL*100), width= .3)+
    labs(title= "Soybean Canopy Coverage", x= "Soil Management", y= "% Canopy Cover")+
  ggsave("SBCarryoverCanopy.jpeg", height= 6, width= 10, dpi=600)
```

```{r}
ggplot(SBcanopyHerbCLD, aes(x= Herb, y= response*100, label= .group, fill= Herb))+
  geom_point(aes(),stat= "identity")+
         theme_bw()+
         geom_text(nudge_y= 3, size = 4)+
         theme(panel.grid.major=element_blank(), panel.grid.minor= element_blank(),
        plot.title= element_text(size=16),
        axis.title.x=element_text(size= 15),
        axis.title.y= element_text(size= 15),
        axis.text= element_text(size= 11))+
         ylim(0,30)+
    geom_errorbar(aes(ymin= lower.CL*100, ymax= upper.CL*100), width= .3)+
    labs(title= , x= "Herbicide Treatment", y= "% Canopy Cover")+
  ggsave("SBCarryoverCanopy_Herbicide.jpeg", height= 6, width= 10, dpi=600)
```

